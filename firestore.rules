rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isAdmin() { return isSignedIn() && request.auth.token.role == 'admin'; }
    function isDevelopment() { return true; } // อนุญาตให้เขียนได้ในโหมด development

    // ข้อมูลห้าง - อ่านได้ทุกคน, เขียนต้องเข้าสู่ระบบ
    match /malls/{mallId} {
      allow read: if true;                 // เปิดให้อ่านได้ทุกคน
      allow write: if isDevelopment();     // เขียนได้ในโหมด development
      
      // ชั้นของห้าง
      match /floors/{floorId} {
        allow read: if true;
        allow write: if isDevelopment();
      }
      
      // ร้านค้าในห้าง
      match /stores/{storeId} {
        allow read: if true;
        allow write: if isDevelopment();
      }
    }

    // ร้านค้าทั่วไป
    match /stores/{storeId} {
      allow read: if true;
      allow write: if isDevelopment();
    }

    // แบรนด์
    match /brands/{brandId} {
      allow read: if true;
      allow write: if isDevelopment();
    }

    // โปรโมชั่น
    match /promotions/{promoId} {
      allow read: if true;
      allow write: if isDevelopment();
    }

    // กิจกรรม
    match /events/{eventId} {
      allow read: if true;
      allow write: if isDevelopment();
    }

    // Collection Group Queries - อนุญาตให้อ่าน stores จากทุกห้าง
    match /{path=**}/stores/{storeId} {
      allow read: if true;
      allow write: if isDevelopment();
    }

    // กันตก - ป้องกันการเข้าถึงเอกสารอื่น ๆ
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}
